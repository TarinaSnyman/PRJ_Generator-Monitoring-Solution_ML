<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Anomaly Detection Dashboard</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
input, button { margin: 5px 0; padding: 5px; }
pre { background: #f4f4f4; padding: 10px; border: 1px solid #ddd; max-height: 300px; overflow:auto; }
.alert { font-weight: bold; padding: 10px; margin: 10px 0; border-radius: 4px; }
.ok { background: #d4edda; color: #155724; }
.error { background: #f8d7da; color: #721c24; }
</style>
</head>
<body>
<h2> Generator Monitoring Integration Testing</h2>

<label>API Key:</label>
<input type="text" id="apiKey" value="key123456">

<h3>1. Health Check</h3>
<button onclick="callHealth()">Check Health</button>
<pre id="healthResult"></pre>

<h3>2. Fetch Raw Data (DB connection)</h3>
<label>AIR ID:</label>
<input type="text" id="fetchAir" value="Epi">
<button onclick="callFetchData()">Fetch Data</button>
<pre id="fetchResult"></pre>

<h3>3. Feature Engineering Test</h3>
<label>AIR ID:</label>
<input type="text" id="featureAir" value="Epi">
<button onclick="callFeatures()">Test Features</button>
<pre id="featureResult"></pre>

<h3>4. Real-Time Status (Anomaly & RUL)</h3>
<label>AIR ID:</label>
<input type="text" id="predictAir" value="Epi">
<div id="statusBlock">
    <div id="predictAlert"></div>
    <pre id="predictResult"></pre>
    <div id="rulResult" style="font-weight:bold; font-size:1.2em;"></div>
</div>

<script>
const serverUrl = "http://127.0.0.1:8000"; // replace with your server IP if needed

function getHeaders() {
    return { "x-api-key": document.getElementById("apiKey").value };
}

function showAlert(id, message, isError=false) {
    const div = document.getElementById(id);
    div.className = "alert " + (isError ? "error" : "ok");
    div.innerText = message;
}

// Health check
function callHealth() {
    fetch(`${serverUrl}/health`)
        .then(res => res.json())
        .then(data => {
            document.getElementById("healthResult").innerText = JSON.stringify(data, null, 2);
            showAlert("healthResult", "âœ… Server healthy, model loaded: " + data.model_loaded);
        })
        .catch(err => showAlert("healthResult", "âŒ Error fetching health", true));
}

// Fetch raw DB data
function callFetchData() {
    const air = document.getElementById("fetchAir").value;
    fetch(`${serverUrl}/fetch_data?air_id=${air}`, { headers: getHeaders() })
        .then(res => res.json())
        .then(data => document.getElementById("fetchResult").innerText = JSON.stringify(data, null, 2))
        .catch(err => document.getElementById("fetchResult").innerText = "Error fetching data");
}

// Feature engineering test
function callFeatures() {
    const air = document.getElementById("featureAir").value;
    fetch(`${serverUrl}/test_features?air_id=${air}`, { headers: getHeaders() })
        .then(res => res.json())
        .then(data => document.getElementById("featureResult").innerText = JSON.stringify(data, null, 2))
        .catch(err => document.getElementById("featureResult").innerText = "Error during feature engineering");
}

// Predict latest anomaly
function updatePredictLatest() {
    const air = document.getElementById("predictAir").value;
    fetch(`${serverUrl}/predict_latest?air_id=${air}`, { headers: getHeaders() })
        .then(res => res.json())
        .then(data => {
            document.getElementById("predictResult").innerText = JSON.stringify(data, null, 2);
            if (data.anomaly === 1) {
                showAlert("predictAlert", "ðŸš¨ Anomaly detected! Probability: " + data.probability.toFixed(3));
            } else {
                showAlert("predictAlert", "âœ… No anomaly detected. Probability: " + data.probability.toFixed(3));
            }
        })
        .catch(err => document.getElementById("predictResult").innerText = "Error fetching anomaly");
}

// Predict RUL
function updateRUL() {
    const air = document.getElementById("predictAir").value;
    fetch(`${serverUrl}/predict_rul?air_id=${air}`, { headers: getHeaders() })
        .then(res => res.json())
        .then(data => {
            document.getElementById("rulResult").innerText = `RUL: ${data.rul_hours} hours`;
        })
        .catch(err => document.getElementById("rulResult").innerText = "Error fetching RUL");
}

// Auto-update every 2 minutes
setInterval(updatePredictLatest, 120000);
setInterval(updateRUL, 120000);

// Optional: run immediately on page load
updatePredictLatest();
updateRUL();
</script>
</body>
</html>
